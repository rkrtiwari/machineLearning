---
title: "Machine Learning"
author: "Ravi Kumar Tiwari"
date: "14 June 2016"
output: pdf_document
---


```{r, echo = TRUE, results='hide', message=FALSE, warning=FALSE}
library(caret)
library(rpart.plot)
library(rattle)
library(calibrate)
library(randomForest)
```

## Decision Tree Example
### Problem Description
Given a data set that contains some observation and corresponding class label, can a machine learning algorithm be trained to determine the class label of any data set (not necessarily the data that was used for training) from its observation

### Solution using decision tree
```{r}
head(iris)
```

Create data partition
```{r}
inTrain <- createDataPartition(iris$Species, p = 0.6, list = FALSE)
trainData <- iris[inTrain,]
testData <- iris[-inTrain,]
```

Build a decision tree model and use it for prediction on test data set
```{r}
treeModel <- train(Species ~ ., data = trainData, method = "rpart")
preClass <- predict(treeModel, newdata = testData)
cMatrix <- confusionMatrix(preClass, testData$Species)
cMatrix$table
```

Look at what are the important variables
```{r}
varImp(treeModel)
```

Visualization of the decision tree

```{r}
fancyRpartPlot(treeModel$finalModel)  
```

\newpage
Alternative visualization of the decision tree

```{r, echo=FALSE}
preClassType <- ifelse(trainData$Species == "setosa", 15, 
                   ifelse(trainData$Species== "versicolor", 17, 19))
plot(trainData$Petal.Length, trainData$Petal.Width, col = trainData$Species, 
     pch = preClassType, xlab = "Petal Length", ylab = "Petal Width")
abline(v = 2.4)
segments(2.4, 1.7, 7.2, 1.7 )
text(x = 2.2, y = 1.1, labels = "Decision Boundary 1", srt = 90)
text(x = 3.9, y = 1.8, labels = "Decision Boundary 2")
```


Visualization of the prediction result

```{r, echo = FALSE}
predResult <- ifelse(preClass == testData$Species, "green", "red")

preClass <- ifelse(testData$Species == "setosa", 15, 
                   ifelse(testData$Species== "versicolor", 17, 19))


plot(testData$Petal.Length, testData$Petal.Width, col = predResult, 
     pch = preClass, cex = 1.2, xlab = "Petal Length", ylab = "Petal Width")
abline(v = 2.4)
segments(2.4, 1.7, 7.2, 1.7 )
text(x = 2.2, y = 1.1, labels = "Decision Boundary 1", srt = 90)
text(x = 3.9, y = 1.8, labels = "Decision Boundary 2")
```


\newpage

## Clustering Example
### K-means clustering

```{r, echo = FALSE}
x <- seq(from=1,to=10,length.out = 10)
set.seed(10)
y1 <- rnorm(5, 4, 0.5)
set.seed(20)
y2 <- rnorm(5, 8, 0.5)
y <- c(y1,y2)
obs <- data.frame(x,y)
```

```{r}
head(obs)
```


```{r, echo = FALSE}
par(mfrow=c(1,1))
plot(x,y, cex = 1.5, pch = 19)
```

Create 2 clusters

```{r}
kmeansObj <-  kmeans(obs, centers = 2)
data.frame(obs, cluster = kmeansObj$cluster)
kmeansObj$centers
```

```{r, echo=FALSE}
plot(x,y, col= kmeansObj$cluster, pch = 19, cex = 1.5, xlim = c(0,12), ylim = c(0,12))
points(kmeansObj$centers, pch = 8, cex = 2.0, col = rownames(kmeansObj$centers))
textxy(x+0.1,y + 0.1, labs = 1:10, cex = 1, col = kmeansObj$cluster)
```

Create 4 clusters

```{r}
kmeansObj <-  kmeans(obs, centers = 4)
data.frame(obs, cluster = kmeansObj$cluster)
kmeansObj$centers
```


```{r, echo = FALSE}
par(mfrow=c(1,1))
plot(x,y, col= kmeansObj$cluster, pch = 19, cex = 1.5, xlim = c(0,12), ylim = c(0,12))
points(kmeansObj$centers, pch = 8, cex = 2.0, col = rownames(kmeansObj$centers))
textxy(x+0.1,y + 0.1, labs = 1:10, cex = 1, col = kmeansObj$cluster)
```

\newpage

### Hierarchical Clustering

```{r, echo = FALSE}
x <- seq(from=1,to=10,length.out = 10)
set.seed(10)
y1 <- rnorm(5, 4, 0.5)
set.seed(20)
y2 <- rnorm(5, 8, 0.5)
y <- c(y1,y2)
par(mfrow=c(1,1))
plot(x,y, xlim = c(0,10), ylim = c(0,10), pch = 19)
```

```{r}
distM <- dist(obs)
clusters <- hclust(distM, method = "ward.D")
```

\newpage
Create 2 partitions

```{r}
mem <- cutree(clusters, k =2)
data.frame(obs, cluster = mem)
```

```{r, echo=FALSE} 
par(mfrow=c(1,2))
plot(clusters)
abline(h=10)
text(5, 12, labels = "2 partitions")
plot(x,y, col=mem, pch = 19, cex = 1.5, xlim = c(0,12), ylim=c(0,12),
     main="Same color points form a group")
textxy(x+0.1,y + 0.1, labs = 1:10, cex = 1, col = mem)
```

\newpage

Create 4 partitions

```{r}
mem <- cutree(clusters, k =4)
data.frame(obs, cluster = mem)
```

```{r, echo=FALSE}
par(mfrow=c(1,2))
plot(clusters)
abline(h=3.5)
text(5, 5, labels = "4 partitions")
plot(x,y, col=mem, pch = 19, cex = 1.5, xlim = c(0,12), ylim=c(0,12),
     main="Same color points form a group")
textxy(x+0.1,y + 0.1, labs = 1:10, cex = 1, col = mem)
```

\newpage

## Cross-validation

```{r, echo = FALSE}
drawPoly <- function(x,y, col){
  polygon(c(x,x+1,x+1,x, x), c(y,y,y+0.5,y+0.5,y), col = col)
}


plot(1, type="n", axes=F, xlab="", ylab="", xlim = c(0.5,6), ylim= c(0,8),
     main = "5 fold cross validation illustration")
for (i in 1:5){
  for (j in 1:5) {
    col <- ifelse(i==j, "red", "green")
    drawPoly(i,j, col)
  }
}

drawPoly(1,6, "red")
drawPoly(1,7, "green")

for(i in 1:5){
  text(i+0.5, 0.5, label = paste("k = ", i, sep = ""))
}

for(i in 1:5){
  text(0.5, i+0.25, label = 6-i)
}

text(3, 7.3, label = "Training Data")
text(3, 6.3, label = "Test Data")
```

\newpage

## random Forest


### ntree


```{r, echo = FALSE}

treeCoordinates <- function(x0, y0){
  n <- 3
  r <- 0.25
  l <- 3
  theta1 <- -pi/3
  theta2 <- -2*pi/3
  xl <- vector("list",n)
  xl[1] <- x0
  for (i in 2:n){
    for (j in seq(1,2^(i-1),by=2)){
      k <- ceiling(j/2)
      xl[[i]][j]   = xl[[i-1]][k] + cos(theta1 - (i-1)*pi/15)*(2*r+l)
      xl[[i]][j+1] = xl[[i-1]][k] + cos(theta2 + (i-1)*pi/15)*(2*r+l)
    }
  }
  
  yl <- vector("list",n)
  yl[1] <- y0
  for (i in 2:n){
    for (j in seq(1,2^(i-1),by=2)){
      k <- ceiling(j/2)
      yl[[i]][j]   = yl[[i-1]][k] + sin(theta1 - (i-1)*pi/15)*(2*r+l)
      yl[[i]][j+1] = yl[[i-1]][k] + sin(theta2 + (i-1)*pi/15 )*(2*r+l)
    }
  }
  
  nx1 <- length(xl)
  ax0l <- vector("list", (n-1))
  ax1l <- vector("list", (n-1))
  ay0l <- vector("list", (n-1))
  ay1l <- vector("list", (n-1))
  
  for(i in 1:(nx1-1)){
    narr <- length(xl[[i]])
    for (j in 1:narr){
      k <- 2*j - 1
      ax0l[[i]][k] <- xl[[i]][j] + r*cos(theta1 - i*pi/15)
      ax0l[[i]][k+1] <- xl[[i]][j] + r*cos(theta2 + i*pi/15)
      ax1l[[i]][k] <- xl[[i]][j] + (r+l)*cos(theta1 - i*pi/15)
      ax1l[[i]][k+1] <- xl[[i]][j] + (r+l)*cos(theta2 + i*pi/15)
      
      ay0l[[i]][k] <- yl[[i]][j] + r*sin(theta1 - i*pi/15)
      ay0l[[i]][k+1] <- yl[[i]][j] + r*sin(theta2 + i*pi/15)
      
      ay1l[[i]][k] <- yl[[i]][j] + (r+l)*sin(theta1 - i*pi/15)
      ay1l[[i]][k+1] <- yl[[i]][j] + (r+l)*sin(theta2 + i*pi/15)
    }
  }
  return(list(xl, yl, ax0l, ay0l, ax1l, ay1l))
}
  



plot(1, type="n", axes=F, xlab="", ylab="", xlim = c(0,15), ylim= c(0,10),
     main = "Random Forest")
treeno <- 1 # 1, 2, "n"
x0 <- 1.35  # 1.35, 5.35, 13.35
y0 <- 7
r <- 0.25

coordinates <- treeCoordinates(x0, y0)
xl <- coordinates[1]
yl <- coordinates[2]
nc <- length(unlist(xl))

ax0l <- coordinates[3]
ay0l <- coordinates[4]
ax1l <- coordinates[5]
ay1l <- coordinates[6]

symbols(x = unlist(xl), y = unlist(yl),  circles = rep(r,nc), 
        bg = "red", add = TRUE, inches = FALSE)
arrows(unlist(ax0l), unlist(ay0l), unlist(ax1l), unlist(ay1l), length = 0.1)
text(x0, y0+1.5, label = paste("tree:", treeno))

treeno <- 2 # 1, 2, "n"
x0 <- 5.35  # 1.35, 5.35, 13.35
y0 <- 7

coordinates <- treeCoordinates(x0, y0)
xl <- coordinates[1]
yl <- coordinates[2]
nc <- length(unlist(xl))

ax0l <- coordinates[3]
ay0l <- coordinates[4]
ax1l <- coordinates[5]
ay1l <- coordinates[6]

symbols(x = unlist(xl), y = unlist(yl),  circles = rep(r,nc), 
        bg = "blue", add = TRUE, inches = FALSE)
arrows(unlist(ax0l), unlist(ay0l), unlist(ax1l), unlist(ay1l), length = 0.1)
text(x0, y0+1.5, label = paste("tree:", treeno))


treeno <- "n" # 1, 2, "n"
x0 <- 13.35  # 1.35, 5.35, 13.35
y0 <- 7

coordinates <- treeCoordinates(x0, y0)
xl <- coordinates[1]
yl <- coordinates[2]
nc <- length(unlist(xl))

ax0l <- coordinates[3]
ay0l <- coordinates[4]
ax1l <- coordinates[5]
ay1l <- coordinates[6]

symbols(x = unlist(xl), y = unlist(yl),  circles = rep(r,nc), 
        bg = "green", add = TRUE, inches = FALSE)
arrows(unlist(ax0l), unlist(ay0l), unlist(ax1l), unlist(ay1l), length = 0.1)
text(x0, y0+1.5, label = paste("tree:", treeno))


symbols(x = seq(8,11, length.out = 5), y = rep(3.671,5),  circles = rep(0.05,5), 
        bg = "black", add = TRUE, inches = FALSE)

```

\newpage

### mtry

```{r, echo = FALSE}
## create 1st rectangle
plot(1, type="n", axes=F, xlab="", ylab="", xlim = c(-5,17), ylim= c(-11,10),
     main = "Random Forest")
symbols(x = 7, y = 9,  rectangles =  matrix(c(10,6), ncol=2), 
        bg = "blue", add = TRUE, inches = FALSE)
xc <- seq(2.5, 11.5, length.out = 9)
xc <- rep(xc,2)
yc <- rep(c(7.2,9.2), each = 9)
rad <- 0.3

set.seed(2000)
col <- sample(c("red", "green"), size = 18, prob = c(0.7, 0.3), replace = TRUE)

symbols(xc, yc,  circles =  rep(rad,18), 
        bg = col, add = TRUE, inches = FALSE)

## create 2nd rectangle
set.seed(100)
index <- sample(1:18, size = 12)

symbols(x = 2, y = 2,  rectangles =  matrix(c(8,4), ncol=2), 
        bg = "blue", add = TRUE, inches = FALSE)

xc <- seq(0, 5.5, length.out = 6)
xc <- rep(xc,2)
yc <- rep(c(1.1,3.1), each = 6)

symbols(xc, yc,  circles =  rep(rad,12), 
        bg = col[index], add = TRUE, inches = FALSE)

text(2, -1.5, labels  = "Random subsample used to build")
text(2, -2.5, labels  = "the tree (2/3 of original)")
## create 3rd rectangle
symbols(x = 14, y = 2,  rectangles =  matrix(c(8,4), ncol=2), 
        bg = "blue", add = TRUE, inches = FALSE)

xc <- seq(11, 15, length.out = 3)
xc <- rep(xc,2)
yc <- rep(c(1.1,3.1), each = 3)

symbols(xc, yc,  circles =  rep(rad,6), 
        bg = col[-index], add = TRUE, inches = FALSE)
text(13, -1.5, labels  = "Random 'OOB' sample")
text(13, -2.5, labels  = "internally validate tree")

## create a decision tree
treeno <- 1 # 1, 2, "n"
x0 <- 1.35  # 1.35, 5.35, 13.35
y0 <- -4
r <- 0.25

coordinates <- treeCoordinates(x0, y0)
xl <- coordinates[1]
yl <- coordinates[2]
nc <- length(unlist(xl))

ax0l <- coordinates[3]
ay0l <- coordinates[4]
ax1l <- coordinates[5]
ay1l <- coordinates[6]

symbols(x = unlist(xl), y = unlist(yl),  circles = rep(r,nc), 
        bg = "red", add = TRUE, inches = FALSE)
arrows(unlist(ax0l), unlist(ay0l), unlist(ax1l), unlist(ay1l), length = 0.1)



## create second decision tree
x0 <- 12  # 1.35, 5.35, 13.35
y0 <- -4

coordinates <- treeCoordinates(x0, y0)
xl <- coordinates[1]
yl <- coordinates[2]
nc <- length(unlist(xl))

ax0l <- coordinates[3]
ay0l <- coordinates[4]
ax1l <- coordinates[5]
ay1l <- coordinates[6]

symbols(x = unlist(xl), y = unlist(yl),  circles = rep(r,nc), 
        bg = "blue", add = TRUE, inches = FALSE)
arrows(unlist(ax0l), unlist(ay0l), unlist(ax1l), unlist(ay1l), length = 0.1)


```



```{r}
rfModel <- randomForest(Species ~ . , data = trainData, ntree = 3)
```